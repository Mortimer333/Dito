class Dito{url;styleNode;params={};headers={};components={};registered=[];_SKIP="_skip";notDownloaded={};downloadCheck={};localStorage=!0;downloadFinished=!1;firstRendered=new Map;constructor(e={}){if(this.detectCSPRestriction())throw new Error("CSP restriction");if(window.__dito)throw new Error("There can be only one instance of Dito");this.url=e.url||window.location.origin,"/"!=this.url[this.url.length-1]&&(this.url+="/"),this.headers=e.headers||this.headers,this.params=e.params||this.params,this.callback=e.callback||(()=>{}),this.arguments=e.arguments||[],this.localStorage=void 0!==e.localStorage?e.localStorage:this.localStorage,this.styleNode=document.createElement("style"),document.head.appendChild(this.styleNode),Object.defineProperty(window,"__dito",{value:{main:this,registered:{}},writable:!1}),this.defineMutationObserver(),this.defineCustomEvents()}defineCustomEvents(){window.__dito.events={},window.__dito.events.render=new CustomEvent("render",{detail:{},bubbles:!1,cancelable:!0,composed:!1}),window.__dito.events.rendered=new CustomEvent("rendered",{detail:{},bubbles:!1,cancelable:!0,composed:!1}),window.__dito.events.firstrender=new CustomEvent("firstrender",{detail:{},bubbles:!1,cancelable:!0,composed:!1}),window.__dito.events.firstrendered=new CustomEvent("firstrendered",{detail:{},bubbles:!1,cancelable:!0,composed:!1})}defineMutationObserver(){const e=new MutationObserver(((e,t)=>{for(const t of e){const e=t?.target?.$self?.binds;if("attributes"===t.type||!e||!e[t.attributeName])return;const{receiver:o,provider:n}=e[t.attributeName];if(t.target.getAttribute(o.name)===n.target.$[n.name])return;n.target.$[n.name]=t.target.getAttribute(o.name)}})),t={attributes:!0};window.__dito.mutationObserve=o=>{e.observe(o,t)}}allDownloaded(){this.downloadFinished||Object.values(window.__dito.main.downloadCheck).length>0||!this.firstRendered.keys().next().done||(this.downloadFinished=!0,this.callback(...this.arguments))}register(e,t,o="",n=!1){if(-1===e.indexOf("-"))throw new Error("Custom elements name must contain hyphen (-)");window.__dito.registered[e]=!0,n||document.querySelector(e)?this.registered.push(...this.createRegisterPromise(o,e,t,n)):this.notDownloaded[e]={name:e,version:t,path:o}}getStorageName(e){return"_dito_"+e}createRegisterPromise(e,t,o,n=!1){let s=!1;if(this.localStorage&&!n&&localStorage.getItem(this.getStorageName(t))){JSON.parse(localStorage.getItem(this.getStorageName(t)))._version==o&&(s=!0)}n||(this.downloadCheck[t]=!0),e=this.url+e+t+"/"+t+".";const r=import(e+"js?v="+o+this.getQuery()),i=s?Promise.resolve(this._SKIP):this.fetch(e+"html?v="+o),a=s?Promise.resolve(this._SKIP):this.fetch(e+"css?v="+o);return[Promise.resolve(t+"_"+o),i.catch((e=>e)),r.catch((e=>e)),a.catch((e=>e))]}async load(e=null){let t=!1;e||(t=!0,e=this.registered);await Promise.all(e).then((async e=>{for(var o=0;o<e.length;o++){let t=e[o+1],n=e[o+2],s=e[o+3];if(t.message||n.message||s.message){console.error("There was unexpected network error at #"+(o/4+1)+". Skipping...",t,n,s),o+=3;continue}if("string"!=typeof e[o]){console.error("The name of component loaded as #"+(o/4+1)+" wasn't found. Skipping..."),o+=3;continue}const r=e[o].split("_"),i=r[r.length-1],a=r.slice(0,-1).join("_");if(!await this.validateFiles(a,{html:t,css:s})){o+=3;continue}const l=JSON.parse(localStorage.getItem(this.getStorageName(a))||"false");if(!l&&(t===this._SKIP||s===this._SKIP)){console.error("The component `"+a+"` was marked as already loaded once but he is missing from localStorage. Skipping..."),o+=3;continue}let c=!1,d=!1;const h=[];t===this._SKIP?(d=!0,t=l.html):h.push(t.text()),s===this._SKIP?(c=!0,s=l.css):h.push(s.text()),await Promise.all(h).then((e=>{d||c?d?c||(t=e[0]):s=e[0]:(t=e[0],s=e[1]),this.saveComponent(a,JSON.stringify({html:t,css:s,_version:i,_time:+new Date}));const r=document.createRange();r.selectNodeContents(document.createElement("div")),r.createContextualFragment(t).querySelector(a)&&console.error("Script detected direct recursive use of components in `"+a+"`. Components' additional call won't be rendered to avoid inifnite loop."),({default:n}=n),Object.defineProperty(n.prototype,"__dito",{value:{actions:{fors:{},for_keys:{},for_values:{},ifs:{},outputs:{},inputs:{},attrs:{},binds:{},events:{},executables:{},packs:{},unames:{},uses:{},gets:{},for_mins:{},for_min_defs:{}},css:{actions:{scopes:{},executables:{},templates:{}},content:"",scoped:[],global:[]}},writable:!1}),n.prototype.__dito.html=t,n.prototype.__dito.css.content=s,this.components[a]={name:a,js:n,html:t,css:s},o+=3,delete this.notDownloaded[a]}))}this.defineElements(document),t&&(this.registered=[])})).catch((e=>console.error(e)))}saveComponent(e,t){if(this.localStorage)try{localStorage.setItem(this.getStorageName(e),t)}catch(o){if(o.name.toLowerCase().match(/quota/)){const o=localStorage.length;if(this.removeOldestComponent(),o===localStorage.length)return void console.error("Component `"+e+"` won't be cached because there is no space in localStorage");this.saveComponent(e,t)}}}isDitoComponentKey(e){return"_dito_"===e.substr(0,6)}removeOldestComponent(){const e={key:null,time:null};for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);if(!this.isDitoComponentKey(o))continue;const n=localStorage.getItem(o);e.time?e.time>n.time&&(e.time=n.time,e.key=o):(e.time=n.time,e.key=o)}e.key&&localStorage.removeItem(e.key)}defineElements(e,t={}){Object.keys(this.components).forEach(function(e){const t=this.components[e];customElements.get(t.name)||"function"!=typeof t.js||customElements.define(t.name,t.js)}.bind(this))}async validateFiles(e,t){const o=Object.keys(t);for(var n=0;n<o.length;n++){const s=t[o[n]];if(!s.ok&&s!==this._SKIP){const t=await s.text();return console.error(key.toUpperCase()+" of component `"+e+"` returned an error: "+t+". Skipping..."),!1}}return!0}fetch(e){let t=this.getQuery();return-1===e.indexOf("?")&&(e+="?",t=t.substr(1)),fetch(e+t,{method:"GET",headers:this.headers})}getQuery(){let e="";const t=Object.keys(this.params);return t.length>0&&t.forEach((t=>{e+="&"+t+"="+encodeURIComponent(this.params[t])})),e}detectCSPRestriction(){try{return new Function("return 1"),!1}catch(e){return e.toString().match(/unsafe-eval|CSP/)&&console.error("It seems you are using the Joints in an environment with Content Security Policy that prohibits unsafe-eval. The template compiler cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions."),!0}}}export{Dito};
