class Dito{url;styleNode;params={};headers={};components={};registered=[];_SKIP="_skip";notDownloaded={};downloadCheck={};localStorage=!0;downloadFinished=!1;firstRendered=new Map;constructor(e={}){if(this.detectCSPRestriction())throw new Error("CSP restriction");if(window.__dito)throw new Error("There can be only one instance of Dito");this.url=e.url||location.origin,this.url.endsWith("/")||(this.url+="/"),this.headers=e.headers||this.headers,this.params=e.params||this.params,this.callback=e.callback||(()=>{}),this.arguments=e.arguments||[],this.localStorage=void 0!==e.localStorage?e.localStorage:this.localStorage,this.styleNode=document.createElement("style"),document.head.appendChild(this.styleNode),this.defineWindowDito(),this.defineMutationObserver(),this.defineCustomEvents()}defineWindowDito(){Object.defineProperty(window,"__dito",{value:{main:this,registered:{}},writable:!1})}generateEvent(e){return new CustomEvent(e,{detail:{},bubbles:!1,cancelable:!0,composed:!1})}defineCustomEvents(){__dito.events={render:this.generateEvent("render"),rendered:this.generateEvent("rendered"),firstrender:this.generateEvent("firstrender"),firstrendered:this.generateEvent("firstrendered"),loadfinished:this.generateEvent("loadfinished")}}defineMutationObserver(){const e=new MutationObserver((e=>{for(const t of e){const e=t?.target?.$self?.binds;if("attributes"===t.type||!e||!e[t.attributeName])return;const{receiver:s,provider:o}=e[t.attributeName];if(t.target.getAttribute(s.name)===o.target.$[o.name])return;o.target.$[o.name]=t.target.getAttribute(s.name)}})),t={attributes:!0};__dito.mutationObserver=s=>{e.observe(s,t)}}allDownloaded(){this.downloadFinished||Object.values(this.downloadCheck).length>0||!this.firstRendered.keys().next().done||(this.downloadFinished=!0,this.callback(...this.arguments))}bulk(e,t,s=""){if(Array.isArray(e)||"object"!=typeof e||null===e)Array.isArray(e)&&this.handleBulk(e,t,s);else{Object.keys(e).forEach((o=>{this.handleBulk(e[o],t,s+o)}))}}handleBulk(e,t,s=""){e.forEach((e=>{if("string"==typeof e){let o=!1;"!"===e[0]&&(o=!0,e=e.substring(1));const n=(s+e).split("/");let r=n.slice(0,-1).join("/");r.length>0&&(r+="/"),this.register(n.slice(-1).join(""),t,r,o)}else Object.keys(e).forEach((o=>{this.handleBulk(e[o],t,s+o)}))}))}register(e,t,s="",o=!1){if(-1===e.indexOf("-"))throw new Error("Custom elements name must contain hyphen (-)");__dito.registered[e]=!0;const n=this.styleNode.sheet;n.insertRule(e+":not([dito-ready]):not([dito-show]) {opacity: 0;}",n.cssRules.length),n.insertRule(e+"[dito-ready]:not([dito-show]) {opacity: 1; transition: opacity .5s;}",n.cssRules.length),o||document.querySelector(e)?this.registered.push(...this.createRegisterPromise(s,e,t,o)):this.notDownloaded[e]={name:e,version:t,path:s}}getStorageName(e){return"_dito_"+e}createRegisterPromise(e,t,s,o=!1){let n=!1;if(this.localStorage&&!o&&localStorage.getItem(this.getStorageName(t))){JSON.parse(localStorage.getItem(this.getStorageName(t)))._version==s&&(n=!0)}o||(this.downloadCheck[t]=!0),e=this.url+e+t+"/"+t+".";const r=import(e+"js?v="+s+this.getQuery()),i=n?Promise.resolve(this._SKIP):this.fetch(e+"html?v="+s+this.getQuery()),a=n?Promise.resolve(this._SKIP):this.fetch(e+"css?v="+s+this.getQuery());return[Promise.resolve(t+"_"+s),i.catch((e=>e)),r.catch((e=>e)),a.catch((e=>e))]}async load(e=null){let t=!1;e||(t=!0,e=this.registered),await Promise.all(e).then((async e=>{for(let t=0;t<e.length;t+=4){const s=await this.handlePromies(e,t);if(!s)continue;let{promises:o,html:n,htmlSkipped:r,css:i,cssSkipped:a,js:l,component:c,version:h}=s;await Promise.all(o).then((e=>{r||a?r?a||(n=e[0]):i=e[0]:(n=e[0],i=e[1]),this.saveComponent(c,JSON.stringify({html:n,css:i,_version:h,_time:+new Date}));document.createRange().selectNodeContents(document.createElement("div")),({default:l}=l),this.defineDito(l,n,i),this.components[c]={name:c,js:l,html:n,css:i},delete this.notDownloaded[c]}))}this.defineElements(),t&&(this.registered=[])})).catch((e=>console.error(e)))}async handlePromies(e,t){let s=e[t+1],o=e[t+2],n=e[t+3];if(s.message||o.message||n.message)return console.error("There was unexpected network error at #"+(t/4+1)+". Skipping...",s,o,n),null;if("string"!=typeof e[t])return console.error("The name of component loaded as #"+(t/4+1)+" wasn't found. Skipping..."),null;const r=e[t].split("_"),i=r[r.length-1],a=r.slice(0,-1).join("_");if(!await this.validateFiles(a,{html:s,css:n}))return null;const l=JSON.parse(localStorage.getItem(this.getStorageName(a))||"false");if(!l&&(s===this._SKIP||n===this._SKIP))return console.error("The component `"+a+"` was marked as already loaded once but he is missing from localStorage. Skipping..."),null;let c=!1,h=!1,d=[];return s===this._SKIP?(h=!0,s=l.html):d.push(s.text()),n===this._SKIP?(c=!0,n=l.css):d.push(n.text()),{promises:d,html:s,htmlSkipped:h,css:n,cssSkipped:c,js:o,component:a,version:i}}defineDito(e,t,s){Object.defineProperty(e.prototype,"__dito",{value:{actions:{fors:{},for_keys:{},for_values:{},ifs:{},outputs:{},inputs:{},attrs:{},binds:{},events:{},executables:{},packs:{},unames:{},uses:{},gets:{},for_mins:{},for_min_defs:{}},css:{actions:{scopes:{},executables:{},templates:{}},content:s,scoped:[],global:[]},html:t},writable:!1})}saveComponent(e,t){if(this.localStorage)try{localStorage.setItem(this.getStorageName(e),t)}catch(s){if(s.name.toLowerCase().match(/quota/)){const s=localStorage.length;if(this.removeOldestComponent(),s===localStorage.length)return void console.error("Component `"+e+"` won't be cached because there is no space in localStorage");this.saveComponent(e,t)}}}isDitoComponentKey(e){return e.startsWith("_dito_")}removeOldestComponent(){const e={key:null,time:null};for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);if(!this.isDitoComponentKey(s))continue;const o=localStorage.getItem(s);e.time?e.time>o.time&&(e.time=o.time,e.key=s):(e.time=o.time,e.key=s)}e.key&&localStorage.removeItem(e.key)}defineElements(){Object.keys(this.components).forEach((e=>{const t=this.components[e];customElements.get(t.name)||"function"!=typeof t.js||customElements.define(t.name,t.js)}))}async validateFiles(e,t){const s=Object.keys(t);for(let o=0;o<s.length;o++){const n=t[s[o]];if(!n.ok&&n!==this._SKIP){const t=await n.text();return console.error(key.toUpperCase()+" of component `"+e+"` returned an error: "+t+". Skipping..."),!1}}return!0}fetch(e){let t=this.getQuery();return-1===e.indexOf("?")&&(e+="?",t=t.substring(1)),fetch(e+t,{method:"GET",headers:this.headers})}getQuery(){let e="";const t=Object.keys(this.params);return t.length>0&&t.forEach((t=>{e+="&"+t+"="+encodeURIComponent(this.params[t])})),e}detectCSPRestriction(){try{return new Function("return 1"),!1}catch(e){return e.toString().match(/unsafe-eval|CSP/)&&console.error("It seems you are using the Dito in an environment with Content Security Policy that prohibits unsafe-eval. The template compiler cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions."),!0}}}export{Dito};
