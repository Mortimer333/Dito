class DitoElement extends HTMLElement{keyName="$key";valueName="$value";nodeName="$node";eventName="$event";indexAtr="dito-i";readyAtr="dito-ready";packAttrName="dito-pack";useNameAttrName="dito-use-name";timeAtr="dito-t";anchorAliasAttr="dito-anchor-alias";cachedScripts={};constructor(){if(super(),this.constructor===DitoElement)throw new Error("DitoElement is an abstract and cannot be instantiated as separate class");this.prepare(),this.defineObservable(),this.saveMethods(),this.$self.cssQueueRenderInProgress=!1,this.$self.queueRenderInProgress=!1,this.defineCallback(),this.defineCssCallback(),this.defineDefaults()}prepare(){}init(){}beforeRender(){}beforeFirstRender(){}afterRender(e){}afterFirstRender(e){}beforeCssRender(){}afterCssRender(e){}getDefaults(){}async connectedCallback(){document.body.contains(this)&&(this.clearRenderQueue(),this.$self.rendered||(window.__dito.main.firstRendered.set(this,!0),delete window.__dito.main.downloadCheck[this.localName],this.beforeFirstRenderActions(),await this.init()),this.queueRender())}defineCallback(){this.$self.debounceRender=this.debounce((e=>{this.$self.queueRenderInProgress=!1,this.render()}))}defineCssCallback(){this.$self.debounceCssRender=this.debounce((e=>{this.$self.cssQueueRenderInProgress=!1,this.cssRender()}))}defineDefaults(){const e=this.getDefaults()||{},t={append:(e,t)=>{const s=this.getAttribute(e)||"";this.setAttribute(e,s+" "+t.value)},replace:(e,t)=>{this.setAttribute(e,t.value)},add:(e,t)=>{const s=this.getAttribute(e)||"";this.setAttribute(e,s+t.value)}};Object.defineProperty(this.$self,"default",{value:e,writable:!1}),Object.keys(e).forEach((function(s){const i=e[s],n=i.type||"append";t[n]?t[n](s,i):console.error("Attribute create as type `"+n+"` is not supported")}))}beforeFirstRenderActions(){const e=this.$self.parent;if(e){(e.$self.toInput.get(this)||[]).forEach((t=>{this.setInput.bind(e)(t,this)}))}this.setCssScope()}setCssScope(){this.$self.css.scoped&&this.queueCssRender(),this.setAttribute(this.timeAtr,+new Date),this.setAttribute(this.indexAtr,Array.prototype.indexOf.call(this.parentElement.children,this)),this.$self.path=this.getPath(this),this.$self.css.path=this.pathToCss(this.$self.path)}saveMethods(){this.methods={};Object.getOwnPropertyNames(this.constructor.prototype).forEach(function(e){"function"==typeof this[e]&&"constructor"!=e&&(this.methods[e]=this[e].bind(this))}.bind(this))}queueRender(){this.$self.queueRenderInProgress=!0,this.$self.debounceRender()}clearRenderQueue(){this.$self.queueRenderInProgress=!1,this.$self.debounceRender("clear")}queueCssRender(){this.$self.cssQueueRenderInProgress=!0,this.$self.debounceCssRender()}clearCssRenderQueue(){this.$self.cssQueueRenderInProgress=!1,this.$self.debounceCssRender("clear")}defineObservable(){Object.defineProperty(this,"$",{value:new Proxy({},{tag:this,set(e,t,s){if("$"==t[0])throw new Error("You can't create variables on this.$ starting with `$`, it's a taken prefix");if(s!==e[t]&&this.tag.queueRender(),this.tag.$bound[t]){const{provider:e}=this.tag.$bound[t];e.target.$[e.name]!==s&&(e.target.$[e.name]=s)}return Reflect.set(...arguments)}}),writable:!1}),Object.defineProperty(this,"$bound",{value:{},writable:!0}),Object.defineProperty(this,"$binder",{value:{},writable:!0}),Object.defineProperty(this,"$css",{value:new Proxy({},{tag:this,set(e,t,s){if("$"==t[0])throw new Error("You can't create variables on this.$css starting with `$`, it's a taken prefix");return s!==e[t]&&this.tag.queueCssRender(t),Reflect.set(...arguments)}}),writable:!1}),this.$output||this.defineOutput(this),this.$self||this.defineSelf(this)}defineSelf(e){Object.defineProperty(e,"$self",{value:{attributes:{},actions:{},setEvents:{},children:[],binds:{},css:{compiled:!1,indices:[],path:null,rendered:!1,queueRenderInProgress:!1,scoped:null},default:{injected:[]},for:{},forBox:{isItem:!1,key:null,value:null,keyName:null,valueName:null,anchor:null,index:null,anchors:[]},forNodes:[],injected:[],injectedPacks:{},parent:null,injectedParent:{},path:null,rendered:!1,rendering:!1,scope:{},toBind:[],toInput:new WeakMap,uniqueChildren:[],uniqueNodes:new WeakMap,childNodes:new WeakMap,get:{},getName:"",template:{}},writable:!0})}defineOutput(e){Object.defineProperty(e,"$output",{value:{},writable:!0})}compileCSS(){this.__dito.css.content=this.compileCSSExecutables(this.__dito.css.content),this.categorizeCssRules(),this.__dito.compiledCSS=!0}categorizeCssRules(){const e=this.separateRules(this.__dito.css.content);this.__dito.css.scoped=[],this.__dito.css.global=[],e.forEach((e=>{-1!==e.indexOf("@self")?this.__dito.css.scoped.push({rule:e,index:-1}):this.__dito.css.global.push({rule:e,index:-1})}));const t=window.__dito.main.styleNode.sheet;this.__dito.css.global.forEach((e=>{e.index=t.cssRules.length,t.insertRule(e.rule,t.cssRules.length)}))}separateRules(e){let t=!1,s=0,i=0;const n=[];for(let r=0;r<e.length;r++){const o=e[r];if(!t&&"{"===o){t=!0;continue}if(!t)continue;if({'"':!0,"'":!0,"`":!0}[o])r=this.getStringEnd(e,o,r+1);else if("{"!==o)if("}"!==o);else{if(i>0){i--;continue}n.push(e.substr(s,r-s+1).trim()),s=r+1,t=!1}else i++}return n}compileCSSExecutables(e){this.__dito.css.actions.executables={};let t=e.indexOf("{{");for(;-1!==t;){const s=e.indexOf("}}",t);if(-1===s)break;const i="exec_"+t+"_"+s;this.__dito.css.actions.executables[i]=e.substr(t+2,s-(t+2)),t=(e=e.replaceAll(e.substr(t,s+2-t),i)).indexOf("{{",t+i.length)}return e}async cssRender(){if(!this.$self.css.queueRenderInProgress&&document.body.contains(this)){this.clearCssRenderQueue(),await this.beforeCssRender();try{this.__dito.compiledCSS||this.compileCSS(),this.$self.css.scoped||(this.$self.css.scoped=JSON.parse(JSON.stringify(this.__dito.css.scoped)));const e=window.__dito.main.styleNode.sheet;this.$self.css.scoped.forEach((t=>{const s=t.rule.replaceAll("@self",this.$self.css.path),i=this.resolveCssExecutables(s);-1===t.index?(t.index=e.cssRules.length,e.insertRule(i,e.cssRules.length)):(e.deleteRule(t.index),e.insertRule(i,t.index))})),await this.afterCssRender({success:!0}),this.$self.css.rendered=!0}catch(e){await this.afterCssRender({success:!1,error:e})}}}resolveCssExecutables(e){const t=this.__dito.css.actions.executables;return Object.keys(t).forEach((s=>{e=e.replaceAll(s,this.getCSSExecuteable(t[s])(...this.getCSSObservablesValues()))})),e}async render(e=!1){if(!e&&(this.$self.queueRenderInProgress||this.$self.rendering||!document.body.contains(this)))return void(document.body.contains(this)||this.dispatchEvent(window.__dito.events.loadfinished));if(this.$self.parent?.$self?.rendering)return void this.queueRender();this.clearRenderQueue(),this.$self.rendering=!0;let t=!1;document.querySelector(this.$self.css.path)!==this&&this.setCssScope(),await this.beforeRender(),this.$self.rendered?this.dispatchEvent(window.__dito.events.render):(await this.beforeFirstRender(),this.dispatchEvent(window.__dito.events.firstrender));try{this.__dito.compiledHTML||this.compile(),this.$self.rendered||(this.$self.default.injected||(this.$self.default.injected=Object.values(this.childNodes)),this.innerHTML=this.__dito.html,this.assignChildren(this),this.retrieveBoundValues(),this.renderInjected(this),this.$self.css.rendered||await this.cssRender()),this.$self.children.forEach((e=>{try{this.actionIf(e,e.$self?.actions?.ifs||[],"ifs")}catch(e){console.error("If error",e)}})),this.$self.forNodes.forEach((e=>{try{this.actionFor(e)}catch(e){console.error("For error",e)}})),this.searchForNotDownloaded(this);const e=[];for(this.querySelectorAll(Object.keys(window.__dito.registered).join(", ")).forEach((t=>{t.$self||this.defineSelf(t),t.$self.parent||(t.$self.parent=this),this.$self.rendered||e.push(new Promise((e=>{const s=i=>{t.removeEventListener("loadfinished",s,!0),e()};t.addEventListener("loadfinished",s,!0)})))}));this.$self.uniqueChildren.length>0;)this.setupUnique(this.$self.uniqueChildren[0]),this.$self.uniqueChildren.splice(0,1);this.$self.children.forEach((e=>{this.actionItem(e)})),this.updateBinds(),await this.afterRender({success:!0}),e.length>0?Promise.all(e).then((e=>{this.dispatchEvent(window.__dito.events.loadfinished)})):this.dispatchEvent(window.__dito.events.loadfinished),this.$self.rendered?this.dispatchEvent(window.__dito.events.rendered):(await this.afterFirstRender({success:!0}),this.dispatchEvent(window.__dito.events.firstrendered),window.__dito.main.firstRendered.delete(this),this.$self.rendered=!0,window.__dito.main.allDownloaded(),this.setAttribute(this.readyAtr,"1")),t=!0}catch(e){console.error("There was an error during rendering",e,this),await this.afterRender({success:!1,error:e})}return this.$self.rendering=!1,t}cloneNodeRecursive(e,t=null){const s=e.cloneNode();return e.$self&&t&&t(e,s),e.childNodes.forEach((e=>{s.appendChild(this.cloneNodeRecursive(e,t))})),s}actionItems(e,t,s=!1){if(e.$self){if(!s&&t.isInjected(e))return;e.$self.forBox.isItem||e.getAttribute&&(!e.getAttribute||e.getAttribute(this.anchorAliasAttr))||e.$self.parent.$self.children.push(e);const i=e.$self.parent;i.setupUnique(e),i.actionItem(e);const n=i.$self.uniqueChildren.indexOf(e);-1!==n&&i.$self.uniqueChildren.splice(n,1)}e.childNodes.forEach((e=>{this.actionItems(e,t,s)}))}renderInjected(e,t=this,s=!1,i=!1){let n=[];return t.querySelectorAll("dito-inject").forEach((t=>{const r=t.$self?.actions?.uses;let o=null;if(r?.length>0){if(r.length>1)throw new Error("Dito inject can have only one use variable");o=this.getExecuteable(r[0],t)(...this.getObservablesValues(t))}t.$self?.actions?.packs?.length>0?t.$self.actions.packs.forEach((l=>{l=this.getExecuteable(l,t)(...this.getObservablesValues(t)),this.$self.default.injected.forEach(function(a){if(3===a.nodeType||!a.getAttribute(this.packAttrName))return;if(this.getExecuteable(a.getAttribute(this.packAttrName),e)(...this.getObservablesValues(e))!=l)return;const[c,h]=this.initInjected(t,a,o,r,s,i);n=n.concat(h)}.bind(this))})):this.$self.default.injected.forEach((e=>{const[l,a]=this.initInjected(t,e,o,r,s,i);n=n.concat(a)})),t.remove()})),n}initInjected(e,t,s,i,n,r){let o=null,l="use",a=[];const c=[],h=[],d=this;s&&t.getAttribute&&t.getAttribute(this.useNameAttrName)?(l=t.getAttribute(this.useNameAttrName),o={[l]:s}):s&&(o={use:s});const f=this.cloneNodeRecursive(t,function(e,t){t.$self=Object.assign({},e.$self),t.$self.injectedParent=d,t.$self.setEvents={},t.$self.toBind=[],t.$self.rendered=!1,t.$self.actions.uses={value:i,name:l},t.$binder={},t.$bound={},e.$self.for.anchor&&(e.$self.for.anchor.$self.children[e.$self.for.index]=t),t.$self.if?.isReplacement&&(t.$self.if.parent.$self.if.replacement=t),e.$output&&(t.$output=Object.assign({},e.$output)),o&&(t.$self.scope=JSON.parse(JSON.stringify(Object.assign({},t.$self.scope,o)))),window.__dito.main.firstRendered.get(e)&&window.__dito.main.firstRendered.delete(e),window.__dito.main.components[t.localName]&&h.push(t),t.getAttribute&&t.getAttribute(this.useNameAttrName)&&t.removeAttribute(this.useNameAttrName),t.$self.children=[],t.$self.for.parent&&(t.$self.for.parent.$self.for.anchors.push(t),t.$self.parent.$self.forNodes.push(t.$self.for.parent),c.push([t.$self.for.parent,t.$self.parent]),e.$self.children.forEach((e=>{e.remove()})),t.$self.forBox.injectParent=n,t.$self.forBox.injectIndex=r),a.push(t),t.$self.parent.$self.children.push(t)}.bind(this.$self.parent));if(!f)throw new Error("Injected node wasn't properly cloned");return e.parentElement.insertBefore(f,e),c.forEach((e=>{e[1].actionFor(e[0])})),h.forEach((e=>{e.setCssScope(),e.defineCallback(),e.defineCssCallback(),e.queueRender()})),f.$self?f.$self.parent?.actionItems(f,this,n):this.$self.parent?.actionItems(f,this,n),[f,a]}tearUnique(e){this.tearEvents(e),this.tearOutput(e),this.tearGets(e)}setupUnique(e,t=!1){this.setupEvents(e),t||this.setupBinds(e),this.setupOutputs(e),this.setupGets(e)}setupGets(e){const t=e.$self?.actions?.gets;if(!t)return;if(t.length>1)throw new Error("You can only retrieve the same node once");const s=this.getExecuteable(t[0],e)(...this.getObservablesValues(e));this.$self.get[s]=e,e.$self.getName=s}tearGets(e){delete this.$self.get[e.$self.getName]}setupOutputs(e){const t=e.$self?.actions?.outputs;t&&t.forEach((t=>{e.$output||this.defineOutput(e),e.$output[t.name]={},e.$output[t.name].emit=async function(s){const i=this.$self.parent,n=this.getObservablesKeys.bind(i)(e),r=this.getObservablesValues.bind(i)(e);try{let o=await this.getFunction.bind(i)(t.value,e,[this.eventName]).bind(i);o=await o(s,...r),this.updateChangedValues.bind(i)(o,n,r)}catch(s){console.error("Error on output",s)}}.bind(e)}))}tearOutput(e){const t=e.$self?.actions?.outputs;t&&t.forEach((t=>{delete e.$output[t.name]}))}setupInputs(e){const t=e.$self?.actions?.inputs;t&&t.forEach((t=>{if(e.$)this.setInput(t,e);else if(window.__dito.registered[e.localName]){const s=this.$self.toInput.get(e);s?this.$self.toInput.set(e,[...s,t]):this.$self.toInput.set(e,[t])}else console.error("Selected node "+e.localName+" was not made with Dito library and can't have assigned input")}))}setInput(e,t){try{t.$[e.name]=this.getExecuteable(e.value,t)(...this.getObservablesValues(t))}catch(t){console.error("Input error - "+e.value,t)}}setupBinds(e){const t=e.$self?.actions?.binds;t&&t.forEach(function(t){void 0!==this.$[t.value]?(e.$?this.setBind(t,e):window.__dito.registered[e.localName]?this.$self.toBind.push({bind:t,node:e}):null!=typeof e[t.name]&&this.setupNativeBind(e,t),this.$self.children.push(e)):console.error("Observable in `"+this.constructor.name+"` doesn't have `"+t.value+"` variable, skipping binding...")}.bind(this))}setupNativeBind(e,t){const{name:s,value:i}=t;e.setAttribute(s,this.$[i]),e.$self||this.defineSelf(e);const n={provider:{target:this,name:i},receiver:{target:e,name:s}};this.$binder[i]?this.$binder[i].push(n):this.$binder[i]=[n],e.$self.binds[s]=n,this.setMutationObserver(e),e.addEventListener("change",function(t){this.$[i]!==e[s]&&void 0!==e[s]&&(this.$[i]=e[s])}.bind(this))}retrieveBoundValues(){this.$self.parent&&this.checkBinds.bind(this.$self.parent)()}checkBinds(){for(let e=0;e<this.$self.toBind.length;e++){const t=this.$self.toBind[e];t.node.$&&(this.setBind(t.bind,t.node),this.$self.toBind.splice(e,1),e--)}}setBind(e,t){const{name:s,value:i}=e;t.$[s]=this.$[i];const n={provider:{target:this,name:i},receiver:{target:t,name:s}};t.$bound[s]=n,this.$binder[i]?this.$binder[i].push(n):this.$binder[i]=[n]}updateBinds(){Object.values(this.$binder).forEach((e=>{e.forEach((e=>{const{receiver:t,provider:s}=e,i=t.target;window.__dito.registered[i.localName]?t.target.$[t.name]=this.$[s.name]:void 0!==i[t.name]?i[t.name]=this.$[s.name]:void 0!==i.getAttribute(t.name)&&i.setAttribute(t.name,this.$[s.name])}))}))}setupEvents(e){const t=e.$self?.actions?.events;t&&t.forEach((t=>{e.$self.setEvents[t.name]||(e.$self.setEvents[t.name]=[]);const s=s=>{const i=this.getObservablesKeys(e),n=this.getObservablesValues(e),r=this.getFunction(t.value,e,[this.eventName])(s,...n);this.updateChangedValues(r,i,n)};e.$self.setEvents[t.name].push(s),e.addEventListener(t.name,s,!1)}))}tearEvents(e){const t=e.$self?.setEvents,s=Object.keys(t);0!=s.length&&s.forEach((s=>{t[s].forEach((t=>{e.removeEventListener(s,t,!1)})),e.$self.setEvents[s]=[]}))}actionItem(e){const t=e.$self?.actions;if(t){try{this.actionIf(e,t.ifs||[],"ifs")}catch(e){console.error("If error",e)}try{this.actionAttrs(e,t.attrs||[],"attrs")}catch(e){console.error("Attr error",e)}try{this.actionExecutables(e,t.executables||[],"executables")}catch(e){console.error("Exec error",e)}try{this.setupInputs(e)}catch(e){console.error("Input error",e)}e.queueRender&&e.queueRender()}}isInIf(e){return!!e.$self?.actions?.ifs||!!e.parentElement&&this.isInIf(e.parentElement)}actionFor(e,t=" "){if(!e.$self.for)throw new Error("Node marked as for doesn't have required values");const{condition:s,anchors:i}=e.$self.for;for(let n=0;n<i.length;n++){const r=i[n];if(!document.body.contains(r.parentElement)){i.length>1&&!this.isInIf(r)&&(e.$self.for.anchors.splice(n,1),n--);continue}r.$self.forGenerated||(r.$self.forGenerated=[]),r.$self.anchorGenerated||(r.$self.anchorGenerated=[]);let o,l,a=this.getExecuteable(s,r)(...this.getObservablesValues(r)),c=typeof a;if("string"==c&&(a*=1,c=typeof a),"number"!=c&&"object"!=c||isNaN(a)&&"object"!=c)return console.error("For in `"+this.constructor.name+"` doesn't have iterable value, removing node...",s),void e.remove();if("number"==c&&(a=new Array(a).fill(null)),e.$self.for.min){const t=this.getExecuteable(e.$self.for.min,r)(...this.getObservablesValues(r));let s;if(e.$self.for.minDef&&(s=this.getExecuteable(e.$self.for.minDef,r)(...this.getObservablesValues(r))),"number"!=typeof t)throw new Error("For min must be a number");a.length<t&&(a=a.concat(new Array(t-a.length).fill(s)))}o=Object.keys(a),l=Object.values(a),this.renderFor(e,r,l,o,t)}}renderFor(e,t,s,i,n){i.length<t.$self.children.length&&(t.$self.children.splice(i.length).forEach((e=>{this.removeFromChildren(e)})),t.$self.anchorGenerated.splice(i.length),t.$self.forGenerated.splice(i.length));const r=document.createElement("div");t.$self.forGenerated.forEach(((n,r)=>{const o=i[r],l=s[r];n.forEach((s=>{this.isInUnique(s)||(s.$self.parent.tearUnique(s),s.$self.parent.setupUnique(s,!0)),s.$self.scope=Object.assign({},s.$self.scope,t.$self.scope),s.$self.forBox.key=o,s.$self.forBox.value=l;const i=s.$self.actions.uses;if(i?.value){s.$self.forBox.keyName=e.$self.forBox.keyName,s.$self.forBox.valueName=e.$self.forBox.valueName;const t=this.getExecuteable(i.value,s)(...this.getObservablesValues(s));s.$self.scope[i.name]=t,s.$self.parent.actionItem(s)}}))})),t.$self.anchorGenerated.forEach(((t,r)=>{const o=i[r],l=s[r];t.forEach((t=>{e.$self.forBox.keyName&&(t.$self.scope[e.$self.forBox.keyName]=o),e.$self.forBox.valueName&&(t.$self.scope[e.$self.forBox.valueName]=l),this.actionFor(t.$self.for.parent,n+"-- ")}))}));const o=this.__dito.actions;for(var l=t.$self.children.length;l<i.length;l++){const n=i[l],a=s[l],c=e.cloneNode(!0);if(t.$self.forGenerated[l]=[],r.appendChild(c),this.iterateOverActions(r,((s,i,r)=>{(r=this.defineChild(r,s,i,o[s][i])).$self.forBox.isItem||(r.$self.forBox.isItem=!0,r.$self.forBox.key=n,r.$self.forBox.value=a,r.$self.forBox.keyName=e.$self.forBox.keyName,r.$self.forBox.valueName=e.$self.forBox.valueName,r.$self.scope=Object.assign({},t.$self.scope,r.$self.scope),t.$self.forGenerated[l].push(r))})),t.parentElement.insertBefore(c,t),t.$self.anchorGenerated[l]=[],e.$self.forBox.anchors.forEach((s=>{const i=c.querySelector(s),r=e.querySelector(s);if(!i||!r)throw new Error("No anchor found!");const o=this.reconstructForAnchor(i,r);o.$self.children=[],o.$self.forGenerated=[];const h=o.$self.for.parent;o.$self.scope=Object.assign({},h.$self.scope,t.$self.scope),e.$self.forBox.keyName&&(o.$self.scope[e.$self.forBox.keyName]=n),e.$self.forBox.valueName&&(o.$self.scope[e.$self.forBox.valueName]=a),t.$self.anchorGenerated[l].push(o),this.actionFor(o.$self.for.parent)})),c.$self||(this.defineSelf(c),c.$self.parent=this,c.$self.for.anchor=t,c.$self.for.index=l),t.$self.children.push(c),this.$self.parent){const e=this.renderInjected(this.$self.parent,c,t,l);t.$self.forGenerated[l]=t.$self.forGenerated[l].concat(e)}}if(3!==t.nodeType){const e=this.reconstructForAnchor(t,t);t.$self.forBox.injectParent&&t.$self.forBox.injectParent.$self.forGenerated[t.$self.forBox.injectIndex].push(e)}}isInUnique(e){return this.$self.uniqueChildren.includes(e)}removeFromChildren(e){const t=[];for(let s=0;s<this.$self.children.length;s++){const i=this.$self.children[s];(e.contains(i)||e===i)&&(t.push(i),this.$self.children.splice(s,1),s--)}return e.remove(),t}reconstructForAnchor(e,t){const s=document.createTextNode("");e.parentElement.replaceChild(s,e),s.$self=Object.assign({},t.$self);return s.$self.for.parent.$self.for.anchors.push(s),t.$self.children.forEach(((e,t)=>{e.$self.for.anchor=s,e.$self.for.index=t})),s}actionExecutables(e,t){if(t.length>1)throw new Error("There can only be one execute script on single node");0!=t.length&&(e.nodeValue=this.getExecuteable(t[0],e)(...this.getObservablesValues(e)))}actionAttrs(e,t){t.forEach((t=>{e.setAttribute(t.name,this.getExecuteable(t.value,e)(...this.getObservablesValues(e)))}))}actionIf(e,t){if(t.length>1)throw new Error("There can only be one if on single node");if(0==t.length)return;e.$self.if||(e.$self.if={condition:t[0],replacement:document.createTextNode("")},this.defineSelf(e.$self.if.replacement),e.$self.if.replacement.$self.parent=this,e.$self.if.replacement.$self.if={isReplacement:!0,parent:e});const s=e.$self.if.replacement;if(!document.body.contains(s)&&!document.body.contains(e))return;const i=this.getExecuteable(e.$self.if.condition,e)(...this.getObservablesValues(e));i&&!document.body.contains(e)?s.parentElement.replaceChild(e,s):!i&&document.body.contains(e)&&e.parentElement.replaceChild(s,e)}getPath(e){const t=this.attributes[this.indexAtr].value,s=this.attributes[this.timeAtr].value,i=e.localName+"@"+t+"@"+s;return this.$self.parent?this.$self.parent.getPath(this.$self.parent)+"."+i:i}pathToCss(e){let t="";return e.split(".").forEach((e=>{const[s,i,n]=e.split("@");t+=s+"["+this.indexAtr+'="'+i+'"]',t+="["+this.timeAtr+'="'+n+'"]',t+=" "})),t.trim()}assignChildren(e){const t=this.__dito.actions,s=Object.keys(t.fors);s.length>0&&(Object.values(e.querySelectorAll("["+s.join("], [")+"]")).reverse().forEach((e=>{this.defineFor(e)})),this.$self.forNodes=this.$self.forNodes.reverse()),this.iterateOverActions(e,((e,s,i)=>{this.defineChild(i,e,s,t[e][s])}))}defineFor(e){const t=this.__dito.actions,s=[],i=[],n=[];let r,o;if(e.getAttributeNames().forEach((e=>{t.fors[e]&&s.push(e),t.for_keys[e]&&i.push(t.for_keys[e]),t.for_values[e]&&n.push(t.for_values[e]),t.for_mins[e]&&(r=t.for_mins[e]),t.for_min_defs[e]&&(o=t.for_min_defs[e])})),s.length>1)throw new Error("There can only be one `for` on single node");if(i.length>1)throw new Error("There can only be one `key` on single node");if(n.length>1)throw new Error("There can only be one `value` on single node");const l=s[0],a=document.createElement("a");if(a.setAttribute("dito-anchor",1),a.setAttribute(this.anchorAliasAttr,l),e.$self||this.defineSelf(e),this.defineSelf(a),a.$self.parent=this,e.removeAttribute(l),i.length>0&&(e.$self.forBox.keyName=i[0]),n.length>0&&(e.$self.forBox.valueName=n[0]),e.$self.forBox.anchors=this.getAnchorPaths(e),this.isInjected(e)){const t=Object.keys(this.__dito.actions.packs);for(let s=0;s<t.length;s++){const i=t[s];if(null!==e.getAttribute(i)){a.setAttribute(i,"");break}}}else this.$self.forNodes.push(e);a.$self.for.parent=e,e.parentElement.replaceChild(a,e),e.$self.for={condition:t.fors[l],anchors:[a],min:r,minDef:o}}isInjected(e){const t={...window.__dito.registered};delete t[this.localName];const s=Object.keys(t),i=this.$self.css.path;if(0===s.length)return!1;const n=i+" "+s.join(" [dito-find-me], "+i+" ")+" [dito-find-me]";3!==e.nodeType?e.setAttribute("dito-find-me",""):e.parentElement.setAttribute("dito-find-me","");let r=!0;return this.querySelector(n)||(r=!1),3!==e.nodeType?e.removeAttribute("dito-find-me"):e.parentElement.removeAttribute("dito-find-me"),r}getAnchorPaths(e){const t=[];return e.querySelectorAll("[dito-anchor]").forEach(((s,i)=>{t.push(this.buildPath(s,e)+'[dito-anchor="'+i+'"]'),s.setAttribute("dito-anchor",i);const n=this.$self.forNodes;for(i=0;i<n.length;i++)if(s.$self.for.parent===n[i]){n.splice(i,1);break}})),t}buildPath(e,t){return e!=t&&e.parentElement?this.buildPath(e.parentElement,t)+" "+e.localName:""}iterateOverActions(e,t){const s=this.__dito.actions;Object.keys(s).forEach((function(i){"fors"!==i&&Object.keys(s[i]).forEach((s=>{e.querySelectorAll("["+s+"]").forEach((e=>{t(i,s,e)}))}))}))}defineChild(e,t,s,i){if("executables"===t){const t=document.createTextNode("");e.parentElement.replaceChild(t,e),e=t}else"packs"===t?e.setAttribute(this.packAttrName,i):"unames"===t&&e.setAttribute(this.useNameAttrName,i);e.$self||this.defineSelf(e),e.$self.actions[t]||(e.$self.actions[t]=[]),e.$self.actions[t].push(i),e.attributes&&e.removeAttribute(s);const n={events:!0,binds:!0,outputs:!0,gets:!0};return n[t]?this.$self.uniqueChildren.includes(e)||this.$self.uniqueChildren.push(e):this.$self.childNodes.get(e)||this.isInjected(e)||(this.$self.children.push(e),this.$self.childNodes.set(e,!0)),this.$self.uniqueNodes.get(e)||(e.$self.parent||(e.$self.parent=this),e.$self.scope||(e.$self.scope=Object.assign({},this.$self.scope)),n[t]&&this.$self.uniqueNodes.set(e,!0)),e}searchForNotDownloaded(e){const t=window.__dito.main.notDownloaded,s=Object.keys(t);if(0==s.length)return;const i=[];e.querySelectorAll(s.join(",")).forEach((e=>{if(t[e.localName]){const s=t[e.localName];delete t[e.localName],i.push(...window.__dito.main.createRegisterPromise(s.path,s.name,s.version))}})),i.length>0&&(async e=>{await window.__dito.main.load(i)})()}updateChangedValues(e,t,s){const i={function:!0,undefined:!0,NaN:!0};t.forEach(((t,n)=>{"$"===t[0]||i[typeof this.$[t]]||i[typeof e[n]]||s[n]===e[n]||(this.$[t]=e[n])}))}compile(){let e=this.__dito.html;e=this.compileFindAndReplace(e,"@b:","b","binds",{hasName:!0}),e=this.compileFindAndReplace(e,"@i:","i","inputs",{hasName:!0}),e=this.compileFindAndReplace(e,"@o:","o","outputs",{hasName:!0}),e=this.compileFindAndReplace(e,"@a:","a","attrs",{hasName:!0}),e=this.compileExecutables(e),e=this.compileFindAndReplace(e,"@e:","e","events",{hasName:!0}),e=this.compileFindAndReplace(e,"@if","if","ifs"),e=this.compileFindAndReplace(e,"@value","v","for_values"),e=this.compileFindAndReplace(e,"@key","k","for_keys"),e=this.compileFindAndReplace(e,"@pack","p","packs"),e=this.compileFindAndReplace(e,"@use","u","uses"),e=this.compileFindAndReplace(e,"@uname","un","unames"),e=this.compileFindAndReplace(e,"@get","g","gets"),e=this.compileFindAndReplace(e,"@min","m","for_mins"),e=this.compileFindAndReplace(e,"@def-min","di","for_min_defs"),this.__dito.html=this.compileFindAndReplace(e,"@for","for","fors"),this.__dito.compiledHTML=!0}compileFindAndReplace(e,t,s,i,n={}){let r,{hasName:o,isCss:l,skipValue:a,replace:c}=n,h=l?this.__dito.css.actions[i]:this.__dito.actions[i];for(;r=this.getCompiledAttribute(e,t,a,0);){const{name:i,value:n}=r,l=c||s+i.start+"-"+n.end;h[l]=o?{name:e.substring(i.start+t.length,i.end).trim(),value:e.substring(n.start+1,n.end)}:e.substring(n.start+1,n.end),e=e.replaceAll(e.substring(i.start,n.end+1),l)}return e}getCompiledAttribute(e,t,s=!1,i=0){const n=e.indexOf(t,i);if(-1===n||0===n&&!/\s/g.test(e[n-1]))return!1;if(s){const e=n+t.length;return{name:{start:n,end:e},value:{start:e,end:e}}}const r=e.indexOf("=",n);if(-1===r)return!1;return{'"':!0,"'":!0,"`":!0}[e[r+1]]?{name:{start:n,end:r},value:{start:r+1,end:this.getStringEnd(e,e[r+1],r+2)}}:(console.error("String wrapper for `"+t+"` in `"+this.constructor.name+"` not found (found letter: `"+e[r+1]+"`), skipping"),this.getCompiledAttribute(e,t,s,r))}getStringEnd(e,t,s=0){const i=e.indexOf(t,s);return"\\"==e[i-1]?this.getStringEnd(test,t,i+1):i}compileExecutables(e){let t=e.indexOf("{{");for(;-1!==t;){const s=e.indexOf("}}",t);if(-1===s)break;const i="exec_"+t+"_"+s;this.__dito.actions.executables[i]=e.substr(t+2,s-(t+2)),t=(e=e.replaceAll(e.substr(t,s+2-t),"<span "+i+"></span>")).indexOf("{{",t+i.length)}return e}cacheScript(e,t,s){this.cachedScripts[e]=new Function(...s,t).bind({})}getExecuteable(e,t){e="return "+e;const s=this.getObservablesKeys(t).join(",")+e;return this.cachedScripts[s]||this.cacheScript(s,e,this.getObservablesKeys(t)),this.cachedScripts[s]}getCSSExecuteable(e){e="return "+e;const t=this.getCSSObservablesKeys(),s=t.join(",")+e;return this.cachedScripts[s]||this.cacheScript(s,e,t),this.cachedScripts[s]}getFunction(e,t,s=[]){this.getObservablesKeys(t);const i=this.getObservablesKeys(t);e=e+"; return ["+i.join(",")+"];";const n=i.join(",")+e;return this.cachedScripts[n]||this.cacheScript(n,e,[...s,...i]),this.cachedScripts[n]}getObservablesKeys(e){return[...Object.keys(this.methods),...Object.keys(this.$),...Object.keys(e.$self.scope),...Object.keys(this.getInjectedScopes(e.$self.injectedParent)),e.$self.forBox.keyName||this.keyName,e.$self.forBox.valueName||this.valueName,this.nodeName]}getCSSObservablesKeys(){return[...Object.keys(this.methods),...Object.keys(this.$css)]}getObservablesValues(e){return[...Object.values(this.methods),...Object.values(this.$),...Object.values(e.$self.scope),...Object.values(this.getInjectedScopes(e.$self.injectedParent)),e.$self.forBox.key,e.$self.forBox.value,e]}getInjectedScopes(e){let t={};return e?.$self?.injectedParent&&(t=Object.assign({},this.getInjectedScopes(e.$self.injectedParent),t)),e?.$self?.scope&&(t=Object.assign({},e.$self.scope,t)),t}getCSSObservablesValues(){return[...Object.values(this.methods),...Object.values(this.$css)]}setMutationObserver(e){window.__dito.mutationObserver(e)}debounce(e,t=10){let s;return(...i)=>{clearTimeout(s),"clear"!==i[0]&&(s=setTimeout((()=>{e.apply(this,i)}),t))}}}export{DitoElement};
