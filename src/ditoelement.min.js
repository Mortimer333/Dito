class DitoElement extends HTMLElement{keyName="$key";valueName="$value";nodeName="$node";eventName="$event";indexAtr="dito-i";readyAtr="dito-ready";packAttrName="dito-pack";useNameAttrName="dito-use-name";timeAtr="dito-t";anchorAliasAttr="dito-anchor-alias";cachedScripts={};constructor(){if(super(),this.constructor===DitoElement)throw new Error("DitoElement is an abstract and cannot be instantiated as separate class");this.prepare(),this.defineObservable(),this.saveMethods(),this.$self.cssQueueRenderInProgress=!1,this.$self.queueRenderInProgress=!1,this.defineCallback(),this.defineCssCallback(),this.defineDefaults()}prepare(){}init(){}beforeRender(){}beforeFirstRender(){}afterRender(e){}afterFirstRender(e){}beforeCssRender(){}afterCssRender(e){}getDefaults(){}async connectedCallback(){document.body.contains(this)&&(this.clearRenderQueue(),this.$self.rendered||(__dito.main.firstRendered.set(this,!0),delete __dito.main.downloadCheck[this.localName],this.beforeFirstRenderActions(),await this.init()),this.queueRender())}defineCallback(){this.$self.debounceRender=this.debounce((e=>{this.$self.queueRenderInProgress=!1,this.render()}))}defineCssCallback(){this.$self.debounceCssRender=this.debounce((e=>{this.$self.cssQueueRenderInProgress=!1,this.cssRender()}))}defineDefaults(){const e=this.getDefaults()||{},t={append:(e,t)=>{const s=this.getAttribute(e)||"";this.setAttribute(e,s+" "+t.value)},replace:(e,t)=>{this.setAttribute(e,t.value)},add:(e,t)=>{const s=this.getAttribute(e)||"";this.setAttribute(e,s+t.value)}};Object.defineProperty(this.$self,"default",{value:e,writable:!1}),Object.keys(e).forEach((s=>{const n=e[s],i=n.type||"append";t[i]?t[i](s,n):console.error('Attribute "create" `'+i+"` is not supported")}))}beforeFirstRenderActions(){const e=this.$self.parent;if(e){(e.$self.toInput.get(this)||[]).forEach((t=>{this.setInput.bind(e)(t,this)}))}this.setCssScope()}setCssScope(){this.$self.css.scoped&&this.queueCssRender(),this.setAttribute(this.timeAtr,+new Date),this.setAttribute(this.indexAtr,Array.prototype.indexOf.call(this.parentElement.children,this)),this.$self.path=this.getPath(this),this.$self.css.path=this.pathToCss(this.$self.path)}saveMethods(){this.methods={};Object.getOwnPropertyNames(this.constructor.prototype).forEach((e=>{"function"==typeof this[e]&&"constructor"!=e&&(this.methods[e]=this[e].bind(this))}))}queueRender(){this.$self.queueRenderInProgress=!0,this.$self.debounceRender()}clearRenderQueue(){this.$self.queueRenderInProgress=!1,this.$self.debounceRender("clear")}queueCssRender(){this.$self.cssQueueRenderInProgress=!0,this.$self.debounceCssRender()}clearCssRenderQueue(){this.$self.cssQueueRenderInProgress=!1,this.$self.debounceCssRender("clear")}defineObservable(){Object.defineProperty(this,"$",{value:new Proxy({},{tag:this,set(e,t,s){if("$"==t[0])throw new Error("You can't create variables on this.$ starting with `$`, it's a taken prefix");if(s!==e[t]&&this.tag.queueRender(),this.tag.$bound[t]){const{provider:e}=this.tag.$bound[t];e.target.$[e.name]=s}return Reflect.set(...arguments)}}),writable:!1}),Object.defineProperty(this,"$bound",{value:{},writable:!0}),Object.defineProperty(this,"$binder",{value:{},writable:!0}),Object.defineProperty(this,"$css",{value:new Proxy({},{tag:this,set(e,t,s){if("$"==t[0])throw new Error("You can't create variables on this.$css starting with `$`, it's a taken prefix");return s!==e[t]&&this.tag.queueCssRender(t),Reflect.set(...arguments)}}),writable:!1}),this.$output||this.defineOutput(this),this.$self||this.defineSelf(this)}defineSelf(e){Object.defineProperty(e,"$self",{value:{attributes:{},actions:{},setEvents:{},children:[],binds:{},css:{compiled:!1,indices:[],path:null,rendered:!1,queueRenderInProgress:!1,scoped:null},default:{injected:[]},for:{},forBox:{isItem:!1,key:null,value:null,keyName:null,valueName:null,anchor:null,index:null,anchors:[]},forNodes:[],injected:[],injectedPacks:{},parent:null,injectedParent:{},path:null,rendered:!1,rendering:!1,scope:{},toBind:[],toInput:new WeakMap,uniqueChildren:[],uniqueNodes:new WeakMap,childNodes:new WeakMap,get:{},getName:"",template:{}},writable:!0})}defineOutput(e){Object.defineProperty(e,"$output",{value:{},writable:!0})}compileCSS(){this.__dito.css.content=this.compileCSSExecutables(this.__dito.css.content),this.categorizeCssRules(),this.__dito.compiledCSS=!0}categorizeCssRules(){const e=this.__dito.css,t=this.separateRules(e.content);e.scoped=[],e.global=[],t.forEach((t=>{-1!==t.indexOf("@self")?e.scoped.push({rule:t,index:-1}):e.global.push({rule:t,index:-1})}));const s=__dito.main.styleNode.sheet;e.global.forEach((e=>{e.index=s.cssRules.length,s.insertRule(e.rule,e.index)}))}separateRules(e){let t=!1,s=0,n=0;const i=[];for(let r=0;r<e.length;r++){const o=e[r];if(!t&&"{"===o){t=!0;continue}if(!t)continue;if({'"':!0,"'":!0,"`":!0}[o])r=this.getStringEnd(e,o,r+1);else if("{"!==o)if("}"!==o);else{if(n>0){n--;continue}i.push(e.substring(s,r+1).trim()),s=r+1,t=!1}else n++}return i}compileCSSExecutables(e){this.__dito.css.actions.executables={};let t=e.indexOf("{{");for(;-1!==t;){const s=e.indexOf("}}",t);if(-1===s)break;const n="exec_"+t+"_"+s;this.__dito.css.actions.executables[n]=e.substring(t+2,s),t=(e=e.replaceAll(e.substring(t,s+2),n)).indexOf("{{",t+n.length)}return e}async cssRender(){const e=this.$self.css;if(!e.queueRenderInProgress&&document.body.contains(this)){this.clearCssRenderQueue(),await this.beforeCssRender();try{this.__dito.compiledCSS||this.compileCSS(),e.scoped||(e.scoped=JSON.parse(JSON.stringify(this.__dito.css.scoped)));const t=__dito.main.styleNode.sheet;e.scoped.forEach((s=>{const n=s.rule.replaceAll("@self",e.path),i=this.resolveCssExecutables(n);-1===s.index?(s.index=t.cssRules.length,t.insertRule(i,t.cssRules.length)):(t.deleteRule(s.index),t.insertRule(i,s.index))})),await this.afterCssRender({success:!0}),e.rendered=!0}catch(e){await this.afterCssRender({success:!1,error:e})}}}resolveCssExecutables(e){const t=this.__dito.css.actions.executables;return Object.keys(t).forEach((s=>{e=e.replaceAll(s,this.getCSSExecuteable(t[s])(...this.getCSSObservablesValues()))})),e}async render(e=!1){const t=this.$self;if(!e&&(t.queueRenderInProgress||t.rendering||!document.body.contains(this)))return void(document.body.contains(this)||this.dispatchEvent(__dito.events.loadfinished));if(t.parent?.$self?.rendering)return void this.queueRender();this.clearRenderQueue(),t.rendering=!0;let s=!1;document.querySelector(t.css.path)!==this&&this.setCssScope(),await this.beforeRender(),t.rendered?this.dispatchEvent(__dito.events.render):(await this.beforeFirstRender(),this.dispatchEvent(__dito.events.firstrender));try{this.__dito.compiledHTML||this.compile(),t.rendered||(t.default.injected||(t.default.injected=Object.values(this.childNodes)),this.innerHTML=this.__dito.html,this.assignChildren(this),this.retrieveBoundValues(),this.renderInjected(this),t.css.rendered||await this.cssRender()),t.children.forEach((e=>{try{this.actionIf(e,e.$self?.actions?.ifs||[])}catch(e){console.error("If error",e)}})),t.forNodes.forEach((e=>{try{this.actionFor(e)}catch(e){console.error("For error",e)}})),this.searchForNotDownloaded(this);const e=[];for(this.querySelectorAll(Object.keys(__dito.registered).join(", ")).forEach((s=>{s.$self||this.defineSelf(s),s.$self.parent||(s.$self.parent=this),t.rendered||e.push(new Promise((e=>{const t=n=>{s.removeEventListener("loadfinished",t,!0),e()};s.addEventListener("loadfinished",t,!0)})))}));t.uniqueChildren.length>0;)this.setupUnique(t.uniqueChildren[0]),t.uniqueChildren.splice(0,1);for(let e=0;e<t.children.length;e++){const s=t.children[e];this.shouldRemoveChild(s)?(t.children.splice(e,1),e--):this.actionItem(s)}this.updateBinds(),await this.afterRender({success:!0}),e.length>0?Promise.all(e).then((e=>{this.dispatchEvent(__dito.events.loadfinished)})):this.dispatchEvent(__dito.events.loadfinished),t.rendered?this.dispatchEvent(__dito.events.rendered):(await this.afterFirstRender({success:!0}),this.dispatchEvent(__dito.events.firstrendered),__dito.main.firstRendered.delete(this),t.rendered=!0,__dito.main.allDownloaded(),this.setAttribute(this.readyAtr,"1")),s=!0}catch(e){console.error("There was an error during rendering",e,this),await this.afterRender({success:!1,error:e})}return t.rendering=!1,s}shouldRemoveChild(e){if(document.contains(e))return!1;const t=this.isInIf(e,!0);return(!t||!document.contains(t)&&!document.contains(t.$self?.if?.replacement))&&!(e.$self.injectedParent instanceof Node&&document.contains(e.$self.injectedParent))}actionItems(e,t,s=!1){if(e.$self){if(!s&&t.isInjected(e))return;e.$self.forBox.isItem||e.getAttribute&&(!e.getAttribute||e.getAttribute(this.anchorAliasAttr))||e.$self.parent.$self.children.push(e);const n=e.$self.parent;n.setupUnique(e),n.actionItem(e);const i=n.$self.uniqueChildren.indexOf(e);-1!==i&&n.$self.uniqueChildren.splice(i,1)}e.childNodes.forEach((e=>{this.actionItems(e,t,s)}))}cloneNodeRecursive(e,t=null){const s=e.cloneNode();return e.$self&&t&&t(e,s),e.childNodes.forEach((e=>{s.appendChild(this.cloneNodeRecursive(e,t))})),s}renderInjected(e,t=this,s=!1,n=!1){let i=[];return t.querySelectorAll("dito-inject").forEach((t=>{const r=t.$self?.actions?.uses;let o=null;if(r?.length>1)throw new Error("Dito inject can have only one use variable");r?.length>0&&(o=this.getExecuteable(r[0],t)(...this.getObservablesValues(t))),t.$self?.actions?.packs?.length>0?t.$self.actions.packs.forEach((l=>{l=this.getExecuteable(l,t)(...this.getObservablesValues(t)),this.$self.default.injected.forEach((a=>{if(3===a.nodeType||!a.getAttribute(this.packAttrName))return;if(this.getExecuteable(a.getAttribute(this.packAttrName),e)(...this.getObservablesValues(e))!=l)return;const[,c]=this.initInjected(t,a,o,r,s,n);i=i.concat(c)}))})):this.$self.default.injected.forEach((e=>{const[,l]=this.initInjected(t,e,o,r,s,n);i=i.concat(l)})),t.remove()})),i}initInjected(e,t,s,n,i,r){let o=null,l="use",a=[];const c=[],h=[],d=this;s&&t.getAttribute&&t.getAttribute(this.useNameAttrName)?(l=t.getAttribute(this.useNameAttrName),o={[l]:s}):s&&(o={use:s});const f=this.cloneNodeRecursive(t,function(e,t){t.$self=Object.assign({},e.$self),t.$self.injectedParent=d,t.$self.setEvents={},t.$self.toBind=[],t.$self.rendered=!1,t.$self.actions.uses=e.$self?.actions?.uses||{value:n,name:l},t.$self.css={compiled:!1,indices:[],path:null,rendered:!1,queueRenderInProgress:!1,scoped:null},t.$binder={},t.$bound={},e.$self.for.anchor&&(e.$self.for.anchor.$self.children[e.$self.for.index]=t),t.$self.if?.isReplacement&&(t.$self.if.parent.$self.if.replacement=t),e.$output&&(t.$output=Object.assign({},e.$output)),o&&(t.$self.scope=Object.assign({},t.$self.scope,o)),__dito.main.firstRendered.get(e)&&__dito.main.firstRendered.delete(e),__dito.main.components[t.localName]&&h.push(t),t.getAttribute&&t.getAttribute(this.useNameAttrName)&&t.removeAttribute(this.useNameAttrName),t.$self.children=[],t.$self.for.parent&&(t.$self.for.parent.$self.for.anchors.push(t),t.$self.parent.$self.forNodes.push(t.$self.for.parent),c.push([t.$self.for.parent,t.$self.parent]),e.$self.children.forEach((e=>{e.remove()})),t.$self.forBox.injectParent=i,t.$self.forBox.injectIndex=r),a.push(t),t.$self.parent.$self.children.push(t)}.bind(this.$self.parent));if(!f)throw new Error("Injected node wasn't properly cloned");return e.parentElement.insertBefore(f,e),c.forEach((e=>{e[1].actionFor(e[0])})),h.forEach((e=>{e.setCssScope(),e.defineCallback(),e.defineCssCallback(),e.queueRender()})),f.$self?f.$self.parent?.actionItems(f,this,i):this.$self.parent?.actionItems(f,this,i),[f,a]}tearUnique(e){this.tearEvents(e),this.tearOutput(e),this.tearGets(e)}setupUnique(e,t=!1){this.setupEvents(e),t||this.setupBinds(e),this.setupOutputs(e),this.setupGets(e)}setupGets(e){const t=e.$self?.actions?.gets;if(!t)return;if(t.length>1)throw new Error("You can only retrieve the same node once");const s=this.getExecuteable(t[0],e)(...this.getObservablesValues(e));this.$self.get[s]=e,e.$self.getName=s}tearGets(e){delete this.$self.get[e.$self.getName],e.$self.getName=null}setupOutputs(e){const t=e.$self?.actions?.outputs;t&&t.forEach((t=>{e.$output||this.defineOutput(e),e.$output[t.name]={emit:async function(s){const n=this.$self.parent,i=this.getObservablesKeys.bind(n)(e),r=this.getObservablesValues.bind(n)(e);try{let o=await this.getFunction.bind(n)(t.value,e,[this.eventName]).bind(n);return o=await o(s,...r),this.updateChangedValues.bind(n)(o.slice(0,-1),i,r),o[o.length-1]}catch(s){console.error("Error on output",s)}}.bind(e)}}))}tearOutput(e){const t=e.$self?.actions?.outputs;t&&t.forEach((t=>{delete e.$output[t.name]}))}setupInputs(e){const t=e.$self?.actions?.inputs;t&&t.forEach((t=>{if(e.$)this.setInput(t,e);else if(__dito.registered[e.localName]){const s=this.$self.toInput.get(e);s?this.$self.toInput.set(e,[...s,t]):this.$self.toInput.set(e,[t])}else console.error("Selected node "+e.localName+" was not made with Dito library and can't have assigned input")}))}setInput(e,t){try{t.$[e.name]=this.getExecuteable(e.value,t)(...this.getObservablesValues(t))}catch(t){console.error("Input error - "+e.value,t)}}setupBinds(e){const t=e.$self?.actions?.binds;t&&t.forEach((t=>{void 0!==this.$[t.value]?(e.$?this.setBind(t,e):__dito.registered[e.localName]?this.$self.toBind.push({bind:t,node:e}):null!=typeof e[t.name]&&this.setupNativeBind(e,t),this.$self.children.push(e)):console.error("Observable in `"+this.constructor.name+"` doesn't have `"+t.value+"` variable, skipping binding...")}))}setupNativeBind(e,t){const{name:s,value:n}=t;e.setAttribute(s,this.$[n]),e.$self||this.defineSelf(e);const i=this.generateBindItem(e,n,s);this.$binder[n]?this.$binder[n].push(i):this.$binder[n]=[i],e.$self.binds[s]=i,this.setMutationObserver(e),e.addEventListener("change",(t=>{this.$[n]!==e[s]&&void 0!==e[s]&&(this.$[n]=e[s])}))}retrieveBoundValues(){this.$self.parent&&this.checkBinds.bind(this.$self.parent)()}checkBinds(){const e=this.$self.toBind;for(let t=0;t<e.length;t++){const s=e[t];s.node.$&&(this.setBind(s.bind,s.node),e.splice(t,1),t--)}}generateBindItem(e,t,s){return{provider:{target:this,name:t},receiver:{target:e,name:s}}}setBind(e,t){const{name:s,value:n}=e;t.$[s]=this.$[n];const i=this.generateBindItem(t,n,s);t.$bound[s]=i,this.$binder[n]?this.$binder[n].push(i):this.$binder[n]=[i]}updateBinds(){Object.values(this.$binder).forEach((e=>{e.forEach((e=>{const{receiver:t,provider:s}=e,n=t.target;__dito.registered[n.localName]?t.target.$[t.name]=this.$[s.name]:void 0!==n[t.name]?n[t.name]=this.$[s.name]:void 0!==n.getAttribute(t.name)&&n.setAttribute(t.name,this.$[s.name])}))}))}setupEvents(e){const t=e.$self?.actions?.events;t&&t.forEach((t=>{e.$self.setEvents[t.name]||(e.$self.setEvents[t.name]=[]);const s=s=>{const n=this.getObservablesKeys(e),i=this.getObservablesValues(e),r=this.getFunction(t.value,e,[this.eventName])(s,...i);this.updateChangedValues(r,n,i)};e.$self.setEvents[t.name].push(s),e.addEventListener(t.name,s,!1)}))}tearEvents(e){const t=e.$self?.setEvents,s=Object.keys(t);0!=s.length&&s.forEach((s=>{t[s].forEach((t=>{e.removeEventListener(s,t,!1)})),e.$self.setEvents[s]=[]}))}actionItem(e){const t=e.$self?.actions;if(t){try{this.actionIf(e,t.ifs||[])}catch(e){console.error("If error",e)}try{this.actionAttrs(e,t.attrs||[])}catch(e){console.error("Attr error",e)}try{this.actionExecutables(e,t.executables||[])}catch(e){console.error("Exec error",e)}try{this.setupInputs(e)}catch(e){console.error("Input error",e)}e.queueRender&&e.queueRender()}}isInIf(e,t=!1,s=!0){let n;return n=e.$self?.actions?.ifs&&this.onlyIfInDocument(e,t)?e:e.parentElement?this.isInIf(e.parentElement,t,!1):!!e.$self?.if?.replacement?.parentElement&&this.isInIf(e.$self?.if?.replacement?.parentElement,t,!1),n}onlyIfInDocument(e,t){return!t||t&&(document.contains(e)||document.contains(e.$self?.if?.replacement))}actionFor(e){if(!e.$self.for)throw new Error("Node marked as for doesn't have required values");const{condition:t,anchors:s}=e.$self.for;for(let n=0;n<s.length;n++){const i=s[n];if(!document.body.contains(i.parentElement)){s.length>1&&!this.isInIf(i)&&(e.$self.for.anchors.splice(n,1),n--);continue}i.$self.forGenerated||(i.$self.forGenerated=[]),i.$self.anchorGenerated||(i.$self.anchorGenerated=[]);let r,o,l=this.getExecuteable(t,i)(...this.getObservablesValues(i)),a=typeof l;if("string"==a&&(l*=1,a=typeof l),"number"!=a&&"object"!=a||isNaN(l)&&"object"!=a)return console.error("For in `"+this.constructor.name+"` doesn't have iterable value, removing node...",t),void e.remove();if("number"==a&&(l=new Array(l).fill(null)),e.$self.for?.min){const t=this.getExecuteable(e.$self.for.min,i)(...this.getObservablesValues(i));let s;if(e.$self.for?.minDef&&(s=this.getExecuteable(e.$self.for.minDef,i)(...this.getObservablesValues(i))),"number"!=typeof t)throw new Error("For min must be a number");l.length<t&&(l=l.concat(new Array(t-l.length).fill(s)))}r=Object.keys(l),o=Object.values(l),this.renderFor(e,i,o,r)}}renderFor(e,t,s,n){n.length<t.$self.children.length&&(t.$self.children.splice(n.length).forEach((e=>{this.removeFromChildren(e)})),t.$self.anchorGenerated.splice(n.length),t.$self.forGenerated.splice(n.length));const i=document.createElement("div");t.$self.forGenerated.forEach(((i,r)=>{const o=n[r],l=s[r];i.forEach((s=>{this.isInUnique(s)||(s.$self.parent.tearUnique(s),s.$self.parent.setupUnique(s,!0)),s.$self.scope=Object.assign({},s.$self.scope,t.$self.scope),s.$self.forBox.key=o,s.$self.forBox.value=l;const n=s.$self.actions.uses;if(n?.value){s.$self.forBox.keyName=e.$self.forBox.keyName,s.$self.forBox.valueName=e.$self.forBox.valueName;const t=this.getExecuteable(n.value,s)(...this.getObservablesValues(s));s.$self.scope[n.name]=t,s.$self.parent.actionItem(s)}}))})),t.$self.anchorGenerated.forEach(((t,i)=>{const r=n[i],o=s[i];t.forEach((t=>{e.$self.forBox.keyName&&(t.$self.scope[e.$self.forBox.keyName]=r),e.$self.forBox.valueName&&(t.$self.scope[e.$self.forBox.valueName]=o),this.actionFor(t.$self.for.parent)}))}));const r=this.__dito.actions;for(var o=t.$self.children.length;o<n.length;o++){const l=n[o],a=s[o],c=e.cloneNode(!0);if(t.$self.forGenerated[o]=[],i.appendChild(c),this.iterateOverActions(i,((s,n,i)=>{(i=this.defineChild(i,s,n,r[s][n])).$self.forBox.isItem||(i.$self.forBox=Object.assign(i.$self.forBox,{isItem:!0,key:l,value:a,keyName:e.$self.forBox.keyName,valueName:e.$self.forBox.valueName}),i.$self.scope=Object.assign({},t.$self.scope,i.$self.scope),t.$self.forGenerated[o].push(i))})),t.parentElement.insertBefore(c,t),t.$self.anchorGenerated[o]=[],e.$self.forBox.anchors.forEach((s=>{const n=c.querySelector(s),i=e.querySelector(s);if(!n||!i)throw new Error("No anchor found!");const r=this.reconstructForAnchor(n,i);r.$self.children=[],r.$self.forGenerated=[];const h=r.$self.for.parent;r.$self.scope=Object.assign({},h.$self.scope,t.$self.scope),e.$self.forBox.keyName&&(r.$self.scope[e.$self.forBox.keyName]=l),e.$self.forBox.valueName&&(r.$self.scope[e.$self.forBox.valueName]=a),t.$self.anchorGenerated[o].push(r),this.actionFor(r.$self.for.parent)})),c.$self||(this.defineSelf(c),c.$self.parent=this,c.$self.for.anchor=t,c.$self.for.index=o),t.$self.children.push(c),this.$self.parent){const e=this.renderInjected(this.$self.parent,c,t,o);t.$self.forGenerated[o]=t.$self.forGenerated[o].concat(e)}}if(3!==t.nodeType){const e=this.reconstructForAnchor(t,t);t.$self.forBox.injectParent&&t.$self.forBox.injectParent.$self.forGenerated[t.$self.forBox.injectIndex].push(e)}}isInUnique(e){return this.$self.uniqueChildren.includes(e)}removeFromChildren(e){const t=[],s=(e.$self?e.$self.parent:this).$self.children;for(let n=0;n<s.length;n++){const i=s[n];(e.contains(i)||e===i)&&(t.push(i),s.splice(n,1),n--)}return e.remove(),t}reconstructForAnchor(e,t){const s=document.createTextNode("");e.parentElement.replaceChild(s,e),s.$self=Object.assign({},t.$self);return s.$self.for.parent.$self.for.anchors.push(s),t.$self.children.forEach(((e,t)=>{e.$self.for.anchor=s,e.$self.for.index=t})),s}actionExecutables(e,t){if(t.length>1)throw new Error("There can only be one execute script on single node");0!=t.length&&(e.nodeValue=this.getExecuteable(t[0],e)(...this.getObservablesValues(e)))}actionAttrs(e,t){t.forEach((t=>{let s=this.getExecuteable(t.value,e)(...this.getObservablesValues(e));"src"!==t.name||s||(s=""),e.setAttribute(t.name,s)}))}actionIf(e,t){if(t.length>1)throw new Error('There can only be one "if" on single node');if(0==t.length)return;if(!e.$self.if){const s=document.createTextNode("");e.$self.if={condition:t[0],replacement:s},this.defineSelf(s),s.$self.parent=this,s.$self.if={isReplacement:!0,parent:e}}const s=e.$self.if.replacement;if(!document.body.contains(s)&&!document.body.contains(e))return;const n=this.getExecuteable(e.$self.if.condition,e)(...this.getObservablesValues(e));n&&!document.body.contains(e)?s.parentElement.replaceChild(e,s):!n&&document.body.contains(e)&&e.parentElement.replaceChild(s,e)}getPath(e){const t=this.attributes[this.indexAtr].value,s=this.attributes[this.timeAtr].value,n=e.localName+"@"+t+"@"+s;return this.$self.parent?this.$self.parent.getPath(this.$self.parent)+"."+n:n}pathToCss(e){let t="";return e.split(".").forEach((e=>{const[s,n,i]=e.split("@");t+=s+"["+this.indexAtr+'="'+n+'"]',t+="["+this.timeAtr+'="'+i+'"]',t+=" "})),t.trim()}assignChildren(e){const t=this.__dito.actions,s=Object.keys(t.fors);s.length>0&&(Object.values(e.querySelectorAll("["+s.join("], [")+"]")).reverse().forEach((e=>{this.defineFor(e)})),this.$self.forNodes=this.$self.forNodes.reverse()),this.iterateOverActions(e,((e,s,n)=>{this.defineChild(n,e,s,t[e][s])}))}defineFor(e){const t=this.__dito.actions,s=[],n=[],i=[];let r,o;if(e.getAttributeNames().forEach((e=>{t.fors[e]&&s.push(e),t.for_keys[e]&&n.push(t.for_keys[e]),t.for_values[e]&&i.push(t.for_values[e]),t.for_mins[e]&&(r=t.for_mins[e]),t.for_min_defs[e]&&(o=t.for_min_defs[e])})),s.length>1)throw new Error("There can only be one `for` on single node");if(n.length>1)throw new Error("There can only be one `key` on single node");if(i.length>1)throw new Error("There can only be one `value` on single node");const l=s[0],a=document.createElement("a");if(a.setAttribute("dito-anchor",1),a.setAttribute(this.anchorAliasAttr,l),e.$self||this.defineSelf(e),this.defineSelf(a),a.$self.parent=this,e.removeAttribute(l),n.length>0&&(e.$self.forBox.keyName=n[0]),i.length>0&&(e.$self.forBox.valueName=i[0]),e.$self.forBox.anchors=this.getAnchorPaths(e),this.isInjected(e)){const t=Object.keys(this.__dito.actions.packs);for(let s=0;s<t.length;s++){const n=t[s];if(null!==e.getAttribute(n)){a.setAttribute(n,"");break}}}else this.$self.forNodes.push(e);a.$self.for.parent=e,e.parentElement.replaceChild(a,e),e.$self.for={condition:t.fors[l],anchors:[a],min:r,minDef:o}}isInjected(e){const t={...__dito.registered};delete t[this.localName];const s=Object.keys(t),n=this.$self.css.path;if(0===s.length)return!1;const i=n+" "+s.join(" [dito-find-me], "+n+" ")+" [dito-find-me]";3!==e.nodeType?e.setAttribute("dito-find-me",""):e.parentElement.setAttribute("dito-find-me","");let r=!0;return this.querySelector(i)||(r=!1),3!==e.nodeType?e.removeAttribute("dito-find-me"):e.parentElement.removeAttribute("dito-find-me"),r}getAnchorPaths(e){const t=[];return e.querySelectorAll("[dito-anchor]").forEach(((s,n)=>{t.push(this.buildPath(s,e)+'[dito-anchor="'+n+'"]'),s.setAttribute("dito-anchor",n);const i=this.$self.forNodes;for(n=0;n<i.length;n++)if(s.$self.for.parent===i[n]){i.splice(n,1);break}})),t}buildPath(e,t){return e!=t&&e.parentElement?this.buildPath(e.parentElement,t)+" "+e.localName:""}iterateOverActions(e,t){const s=this.__dito.actions;Object.keys(s).forEach((n=>{"fors"!==n&&Object.keys(s[n]).forEach((s=>{e.querySelectorAll("["+s+"]").forEach((e=>{t(n,s,e)}))}))}))}defineChild(e,t,s,n){if("executables"===t){const t=document.createTextNode("");e.parentElement.replaceChild(t,e),e=t}else"packs"===t?e.setAttribute(this.packAttrName,n):"unames"===t&&e.setAttribute(this.useNameAttrName,n);e.$self||this.defineSelf(e),e.$self.actions[t]||(e.$self.actions[t]=[]),e.$self.actions[t].push(n),e.attributes&&e.removeAttribute(s);const i={events:!0,binds:!0,outputs:!0,gets:!0};return i[t]?this.$self.uniqueChildren.includes(e)||this.$self.uniqueChildren.push(e):this.$self.childNodes.get(e)||this.isInjected(e)||(this.$self.children.push(e),this.$self.childNodes.set(e,!0)),this.$self.uniqueNodes.get(e)||(e.$self.parent||(e.$self.parent=this),e.$self.scope||(e.$self.scope=Object.assign({},this.$self.scope)),i[t]&&this.$self.uniqueNodes.set(e,!0)),e}searchForNotDownloaded(e){const t=__dito.main.notDownloaded,s=Object.keys(t);if(0==s.length)return;const n=[];e.querySelectorAll(s.join(",")).forEach((e=>{if(t[e.localName]){const s=t[e.localName];delete t[e.localName],n.push(...__dito.main.createRegisterPromise(s.path,s.name,s.version))}})),n.length>0&&__dito.main.load(n)}updateChangedValues(e,t,s){const n={function:!0,undefined:!0,NaN:!0};t.forEach(((t,i)=>{"$"===t[0]||n[typeof this.$[t]]||n[typeof e[i]]||s[i]===e[i]||(this.$[t]=e[i])}))}compile(){let e=this.__dito.html;e=this.compileFindAndReplace(e,"@b:","b","binds",{hasName:!0}),e=this.compileFindAndReplace(e,"@i:","i","inputs",{hasName:!0}),e=this.compileFindAndReplace(e,"@o:","o","outputs",{hasName:!0}),e=this.compileFindAndReplace(e,"@a:","a","attrs",{hasName:!0}),e=this.compileExecutables(e),e=this.compileFindAndReplace(e,"@e:","e","events",{hasName:!0}),e=this.compileFindAndReplace(e,"@if","if","ifs"),e=this.compileFindAndReplace(e,"@value","v","for_values"),e=this.compileFindAndReplace(e,"@key","k","for_keys"),e=this.compileFindAndReplace(e,"@pack","p","packs"),e=this.compileFindAndReplace(e,"@use","u","uses"),e=this.compileFindAndReplace(e,"@uname","un","unames"),e=this.compileFindAndReplace(e,"@get","g","gets"),e=this.compileFindAndReplace(e,"@min","m","for_mins"),e=this.compileFindAndReplace(e,"@def-min","di","for_min_defs"),this.__dito.html=this.compileFindAndReplace(e,"@for","for","fors"),this.__dito.compiledHTML=!0}compileFindAndReplace(e,t,s,n,i={}){let r,{hasName:o,isCss:l,skipValue:a,replace:c}=i,h=l?this.__dito.css.actions[n]:this.__dito.actions[n];for(;r=this.getCompiledAttribute(e,t,a,0);){const{name:n,value:i}=r,l=c||s+n.start+"-"+i.end;h[l]=o?{name:e.substring(n.start+t.length,n.end).trim(),value:e.substring(i.start+1,i.end)}:e.substring(i.start+1,i.end),e=e.replaceAll(e.substring(n.start,i.end+1),l)}return e}getCompiledAttribute(e,t,s=!1,n=0){const i=e.indexOf(t,n);if(-1===i||0===i&&!/\s/g.test(e[i-1]))return!1;if(s){const e=i+t.length;return{name:{start:i,end:e},value:{start:e,end:e}}}const r=e.indexOf("=",i);if(-1===r)return!1;return{'"':!0,"'":!0,"`":!0}[e[r+1]]?{name:{start:i,end:r},value:{start:r+1,end:this.getStringEnd(e,e[r+1],r+2)}}:(console.error("String wrapper for `"+t+"` in `"+this.constructor.name+"` not found (found letter: `"+e[r+1]+"`), skipping"),this.getCompiledAttribute(e,t,s,r))}getStringEnd(e,t,s=0){const n=e.indexOf(t,s);return"\\"==e[n-1]?this.getStringEnd(e,t,n+1):n}compileExecutables(e){let t=e.indexOf("{{");for(;-1!==t;){const s=e.indexOf("}}",t);if(-1===s)break;const n="exec_"+t+"_"+s;this.__dito.actions.executables[n]=e.substring(t+2,s),t=(e=e.replaceAll(e.substring(t,s+2),"<span "+n+"></span>")).indexOf("{{",t+n.length)}return e}cacheScript(e,t,s){this.cachedScripts[e]=new Function(...s,t).bind({})}getExecuteable(e,t){e="return "+e;const s=this.getObservablesKeys(t).join(",")+e;return this.cachedScripts[s]||this.cacheScript(s,e,this.getObservablesKeys(t)),this.cachedScripts[s]}getCSSExecuteable(e){e="return "+e;const t=this.getCSSObservablesKeys(),s=t.join(",")+e;return this.cachedScripts[s]||this.cacheScript(s,e,t),this.cachedScripts[s]}getFunction(e,t,s=[]){const n=this.getObservablesKeys(t);0===e.length&&(e="null"),e="const $result = "+e+"; return ["+n.join(",")+", $result];";const i=n.join(",")+e;return this.cachedScripts[i]||this.cacheScript(i,e,[...s,...n]),this.cachedScripts[i]}getObservablesKeys(e){return[...Object.keys(this.methods),...Object.keys(this.$),...Object.keys(e.$self.scope),...Object.keys(this.getInjectedScopes(e.$self.injectedParent)),e.$self.forBox.keyName||this.keyName,e.$self.forBox.valueName||this.valueName,this.nodeName]}getCSSObservablesKeys(){return[...Object.keys(this.methods),...Object.keys(this.$css)]}getObservablesValues(e){return[...Object.values(this.methods),...Object.values(this.$),...Object.values(e.$self.scope),...Object.values(this.getInjectedScopes(e.$self.injectedParent)),e.$self.forBox.key,e.$self.forBox.value,e]}getInjectedScopes(e){let t={};return e?.$self?.injectedParent&&(t=Object.assign({},this.getInjectedScopes(e.$self.injectedParent),t)),e?.$self?.scope&&(t=Object.assign({},e.$self.scope,t)),t}getCSSObservablesValues(){return[...Object.values(this.methods),...Object.values(this.$css)]}setMutationObserver(e){__dito.mutationObserver(e)}debounce(e,t=10){let s;return(...n)=>{clearTimeout(s),"clear"!==n[0]&&(s=setTimeout((()=>{e.apply(this,n)}),t))}}}export{DitoElement};
